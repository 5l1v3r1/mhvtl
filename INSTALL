
mh virtual tape & library system.


Instructions assume reader is familiar with the kernel build process.

There are two sections of code to build.
- The kernel module
- The user-space daemons.

Kernel module vtl: 
==================
1) Make sure the kernel-devel package to match your running kernel is installed.
e.g.
RedHat AS 4 & 5:
# rpm -qa|grep kernel
kernel-2.6.9-34.0.1.EL
kernel-devel-2.6.9-34.0.1.EL
kernel-2.6.9-5.EL
kernel-devel-2.6.9-5.EL
kernel-utils-2.4-13.1.80

SLES 9 & 10:
# rpm -qa|grep kernel


2) Extract the mhvtl source code.
# tar xvfz mhvtl-2008-03-05.tgz

3) Change directory into the kernel driver source.
# cd mhvtl-0.15/kernel-driver/linux-2.6
# make
# make install



User space daemons:
===================
Pre-req for a running vtl
- lsscsi (http://www.torque.net/scsi/lsscsi.html)
- sg3_utils (http://www.torque.net/sg/)

Pre-req to build/compile userspace:
- zlib-devel

* To build an RPM 
  ===============
 cp vtl-YYYY-MM-DD.tar.gz /usr/src/packages/SOURCE/
 cd /usr/src/packages/SOURCE
 rpmbuild -tb vtl-YYYY-MM-DD.tar.gz
 <wait for rpm build to complete>
 rpm -Uvh /usr/src/packages/RPMS/<cpu type>/mhvtl-0.15-z.<cpu type>.rpm
 (The rpm install will create system group & accounts vtl)

* To build from tar archive (Debian / Ubuntu):
  ============================================
 apt-get install lsscsi
 apt-get install sg3_utils

To limit damage that may occur by wayward daemons, I highly recommend creating
a group and user called 'vtl'
# /usr/sbin/groupadd --system vtl
# /usr/sbin/useradd --system -c "Vitrual Tape Library" -d /opt/vtl -g vtl -m vtl

Now build user space daemons:
From the parent directory where you extracted the source.
# cd mhvtl-0.15

Build the binaries
# make

Install the rc script into /etc/init.d/ and binaries to /usr/local/bin/
# make install

Make config directory :
mkdir /etc/mhvtl
chown vtl:vtl /etc/mhvtl
chmod 770 /etc/mhvtl

Copy the library_contents.sample to /etc/mhvtl/library_contents
Edit the /etc/mhvtl/library_contents to suite your environment.
Note: If changing Storage slots, stop and re-start daemons via the rc script:
 /etc/init.d/mhvtl
Part of the rc scripts job is to create 'blank' media in the /opt/vtl/
directory and dynamically build the robot contents.

There is no way of HUPing the daemons to re-read the configuration file contents.


Start daemons:
/etc/init.d/mhvtl start

Test:
Note: Make sure the 'mtx' & 'lsscsi' utilities are installed
e.g.
# lsscsi -g
[0:0:0:0]    mediumx STK      L700             vtl0  -         /dev/sg0
[1:0:0:0]    tape    SONY     SDX-900V         5400  /dev/st0  /dev/sg1
[1:0:0:1]    tape    SONY     SDX-900V         5400  /dev/st1  /dev/sg2
[1:0:0:2]    tape    QUANTUM  SDLT600          5400  /dev/st2  /dev/sg3
[1:0:0:3]    tape    QUANTUM  SDLT600          5400  /dev/st3  /dev/sg4
[1:0:0:4]    tape    QUANTUM  SDLT600          5400  /dev/st4  /dev/sg5
[1:0:0:5]    tape    IBM      ULT3580-TD3      5400  /dev/st5  /dev/sg6
[1:0:0:6]    tape    IBM      ULT3580-TD3      5400  /dev/st6  /dev/sg7
[1:0:0:7]    tape    IBM      ULT3580-TD3      5400  /dev/st7  /dev/sg8


# mtx -f /dev/sg0
  Storage Changer /dev/sg0:8 Drives, 36 Slots ( 4 Import/Export )
Data Transfer Element 0:Empty
Data Transfer Element 1:Empty
Data Transfer Element 2:Empty
Data Transfer Element 3:Empty
Data Transfer Element 4:Empty
Data Transfer Element 5:Empty
Data Transfer Element 6:Empty
Data Transfer Element 7:Empty
      Storage Element 1:Full :VolumeTag=ULT001L1
      Storage Element 2:Full :VolumeTag=ULT002L1
      Storage Element 3:Full :VolumeTag=ULT003L1
      Storage Element 4:Full :VolumeTag=ULT004L1
      Storage Element 5:Full :VolumeTag=ULT005L1
      Storage Element 6:Full :VolumeTag=ULT006L1
      Storage Element 7:Full :VolumeTag=ULT007L1
      Storage Element 8:Full :VolumeTag=ULT008L1
      Storage Element 9:Full :VolumeTag=ULT009L1
      Storage Element 10:Full :VolumeTag=ULT010L1
      Storage Element 11:Full :VolumeTag=SDLT01L1
      Storage Element 12:Full :VolumeTag=SDLT02L1
      Storage Element 13:Full :VolumeTag=SDLT03L1
      Storage Element 14:Full :VolumeTag=SDLT04L1
      Storage Element 15:Full :VolumeTag=SDLT05L1
      Storage Element 16:Full :VolumeTag=SDLT06L1
      Storage Element 17:Full :VolumeTag=SDLT07L1
      Storage Element 18:Full :VolumeTag=SDLT08L1
      Storage Element 19:Full :VolumeTag=SDLT09L1
      Storage Element 20:Full :VolumeTag=SDLT10L1
      Storage Element 21:Empty
      Storage Element 22:Empty
      Storage Element 23:Empty
      Storage Element 24:Empty
      Storage Element 25:Empty
      Storage Element 26:Empty
      Storage Element 27:Empty
      Storage Element 28:Empty
      Storage Element 29:Empty
      Storage Element 30:Empty
      Storage Element 31:Full :VolumeTag=CLN001L1
      Storage Element 32:Full :VolumeTag=CLN002L1
      Storage Element 33 IMPORT/EXPORT:Empty
      Storage Element 34 IMPORT/EXPORT:Empty
      Storage Element 35 IMPORT/EXPORT:Empty
      Storage Element 36 IMPORT/EXPORT:Empty


Enjoy.

Please feel free in letting me know if this works for you.

Bug fixes and suggestions always welcome.

markh794@gmail.com
mark_harvey@symantec.com

